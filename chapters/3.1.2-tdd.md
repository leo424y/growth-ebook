測試驅動開發
---

測試驅動開發是一個很"古老"的程式開發方法，然而由於國內開發流程的問題——即開發人員負責功能的測試，導致這麼好的一項技術沒有在國內推廣。

###紅-綠-重構

測試驅動開發的主要過程是: 紅 —> 綠 -> 重構

![TDD](assets/article/chapter3/tdd.jpg)

1. 先寫一個失敗的單元測試。即我們並沒有實現這個方法，但是已經有了這個方法的測試。
2. 讓測試通過。實現簡單的程式碼來保證測試通過，就算我們用一些作弊的方法也是可以的。我們寫的是功能程式碼，那麼我們應該提交程式碼，因為我們已經實現了這個功能。
3. 重構，並改進功能程式碼，讓它變得更加合理。

TDD 有助於我們將問題分解成更小的部分，再一點點的新增我們所需要的業務程式碼。隨著這個過程的不斷進行，我們會發現我們已經接近完成我們的功能程式碼了。並且到了最後，我們會發現我們的程式碼都會被測試到。


雖然說起來很簡單，但是真正實現起來並不是那麼容易。於我而言我只會在我自己造的一些輪子中使用 TDD。因為這個花費大量的時間，通常來說測試程式碼和功能程式碼的比例可能是1:1，或者是2：1等等。在自己建立的一些個人應用，如部落格中，我不需要與其他人 Share 我的 Content。由於我使用的是第三方框架，框架本身的測試已經足夠多，並且沒有複雜的邏輯，我就沒有對我的部落格寫測試。而在我寫的一些框架裡，我就會盡量保證足夠高的測試覆蓋率，並且在適當的時候會去 TDD。

通常來說對於單元測試我會採用 TDD 的方式來進行，但是功能測試仍會選擇在最後新增進去。主要的緣由是：在寫 UI 的過程中，元素會發生變化。這一點和我們在寫 Unit 的時候，有很大的區別。div + class 會使得我們思考問題的方式發生變化，我們需要去點選某個元素，並觀察某個元素髮生的變化。而多數時候，我們很難把握好一個頁面最後的樣子。

不得不說明的一點是，TDD 需要你對測試比較瞭解後，才容易使用它。從個人的感受來說，TDD 在一開始是一件很難的事。

###測試先行

對於寫測試的人來說，測試先行有點難以理解，而對於不寫測試的人來說，就更難以理解。這裡假定你已經開始寫測試了，因為對於不寫測試的人來說，寫測試就是一件難以理解的事。既然我們都要寫測試，那麼為什麼我們就不能先寫測試呢？或者說為什麼後寫測試存在一些問題？

依據 J.Timothy King 所總結的《測試先行的12個好處》：

1. 測試可證明你的程式碼是可以解決問題的
2. 一面寫單元測試，一面寫實現程式碼，這樣感覺更有興趣
3. 單元測試也可以用於演示程式碼
4. 會讓你在寫程式碼之前做好計劃
5. 它降低了 Bug 修復的成本
6. 可以得到一個底層模組的迴歸測試工具
7. 可以在不改變現有功能的基礎上繼續改進你的設計
8. 可以用於展示開發的進度
9. 它真實的為程式設計師消除了工作上的很多障礙
10. 單元測試也可以讓你更好的設計
11. 單元測試比程式碼審查的效果還要好
12. 它比直接寫程式碼的效率更高

但是在我個人的感覺裡，比較喜歡的是： **寫出可以測試的函數**。這是一個一直困擾著我的難題，特別是當我的程式碼裡存在很多條件的時候，在後期我編寫的時候，難度越來越大。當我只有一個簡單的 IF-ELSE 的時候，我的程式碼測試起來也很簡單:

```javascript
if (hour < 18) {
    greeting = "Good day";
} else {
    greeting = "Good evening";
}
```

而當我有複雜的業務邏輯時，後寫測試就會變成一場惡夢：

```javascript
if (EchoesWorks.isObject(words)) {
	var nextTime = that.parser.parseTime(that.data.times)[currentSlide + 1];
	if (that.time < nextTime && words.length > 1) {
		var length = words.length;
		var currentTime = that.parser.parseTime(that.data.times)[currentSlide];
		var time = nextTime - currentTime;
		var average = time / length * 1000;
		var i = 0;
		document.querySelector('words').innerHTML = words[i].word;

		timerWord = setInterval(function () {
			i++;
			if (i - 1 === length) {
				clearInterval(timerWord);
			} else {
				document.querySelector('words').innerHTML = words[i].word;
			}
		}, average);
	}
	return timerWord;
} else {
	document.querySelector('words').innerHTML = words;
}
```

我們需要重新理清業務的邏輯，再依據這些邏輯來編寫測試程式碼。而當我們已經忘記具體的業務邏輯時，我們已然無法寫出測試。

**思考**

通常在我的理解下，TDD 是可有可無的。既然我知道了我要實現的大部分功能，而且我也知道如何實現。與此同時，對 Code Smell 也保持著警惕、要保證功能被測試覆蓋。那麼，總的來說 TDD 帶來的價值並不大。

然而，在當前這種情況下，我知道我想要的功能，但是我並不理解其深層次的功能。我需要花費大量的時候來理解，它為什麼是這樣的，需要先有一些指令碼來知道它是怎麼工作的。TDD 變顯得很有價值，換句話來說，在現有的情況下，TDD 對於我們不瞭解的一些事情，可以驅動出更多的開發。畢竟在我們完成測試指令碼之後，我們也會發現這些測試指令碼成為了程式碼的一部分。

在這種理想的情況下，我們為什麼不 TDD 呢?

參考資料

 J.Timothy King 《Twelve Benefits of Writing Unit Tests First》
