持續整合
---

更關注程式碼質量。持續整合是為了確保隨著需求變化而變化的程式碼，在實現功能的同時，質量不受影響。因此，在每一次構建後會執行單元測試，保證程式碼級的質量。單元測試會針對每一個特定的輸入去判斷和觀察輸出的結果，而單元測試的粒度則用來平衡持續整合的質量和速度。

持續整合的核心價值在於[^CI]：

1. 持續整合中的任何一個環節都是自動完成的，無需太多的人工干預，有利於減少重複過程以節省時間、費用和工作量；
2. 持續整合保障了每個時間點上團隊成員提交的程式碼是能成功整合的。換言之，任何時間點都能第一時間發現軟體的整合問題，使任意時間釋出可部署的軟體成為了可能；
3. 持續整合還能利於軟體本身的發展趨勢，這點在需求不明確或是頻繁性變更的情景中尤其重要，持續整合的質量能幫助團隊進行有效決策，同時建立團隊對開發產品的信心。

###持續整合系統

在前面的內容裡，我們已經介紹了持續整合的各項基礎設施——如使用版本管理、編寫測試、自動化部署。要構建這樣的一個持續整合系統需要下面的內容：

 - 支援自動構建
 - 源碼伺服器
 - 持續整合伺服器

我們已經實現了前兩點，針對於第三點——持續整合伺服器，我們可以以 Jenkins 為例做一些簡單的說明。它是一種基於 Java 開發的持續整合工具，並提供了用於監控持續重複工作的軟體平臺。

它可以讓整個開發流程到部署都實現自動化。由於每個功能可以一點點的加在 build 中，那麼這樣就能保證每次的新 build 可以交付新的功能。同時，我們可以根據使用者的反饋情況及時調整開發方向，降低項目風險。

###持續整合流程

我們就可以對這個工作流展開深入介紹。持續整合主要就是要保證整個過程是**可持續**的。如下圖是一個持續整合的工作流：

![CI Workflow](assets/article/chapter6/ci.jpg)

不同的開發者在自己的機器上開發功能程式碼。在完成一定的本地提交後，這些程式碼將會提交給原始碼控制伺服器。不過，在那之前我們應該在本地跑測試來減少持續整合失敗的情況。接著，我們的CI會定時去獲取源碼伺服器是否有程式碼修改。如果有程式碼修改，那麼我們的整合伺服器將會獲取這些程式碼。然後，構建這個項目，執行測試，再輸出返回結果。最後，我們可以開發一些小工具來提醒使用者 CI 是否執行成功。

如果這個過程中 CI 執行失敗的話，那麼我們就不能再提交新的程式碼——除了修復 CI 的程式碼外。持續整合變紅不能過夜，要麼快速解決，要麼回退。

在這個過程中，有兩點值得注意，一個是小步前進，一個是遲早反饋。

####小步前進

小步前進是一系列步驟的集合，其目的是：整合越早問題越小。即當我們的程式碼越早的提交到源碼伺服器，那麼其他人就可以儘可能早的和我們的程式碼整合到一起。這也意味著，每天結束時，我們在本地的修改要儘可能小，並且這些修改還要保證不會破壞持續整合。

我們需要頻繁地在本地提交我們的程式碼，編寫獨立的測試——如果我們在最後才編寫測試，就會拖慢整個流程，它使得我們不能儘可能早的提交程式碼。

####儘早反饋

> 反饋越早，那麼問題越小。

無論是精益還是敏捷都在強調一點——儘早反饋，反饋對於提高敏捷開發流程效力非常重要。從日常的：

 - Code Review
 - 靜態程式碼分析
 - 自動整合測試
 - 自動驗收測試
 - 高頻率釋出

我們都在做盡可能小的反饋，這些實踐對於我們完成一個好的持續整合來說是非常重要的基礎。

參考資料：

 -《持續交付：釋出可靠軟體的系統方法》

[^CI]: [基於 Jenkins 快速搭建持續整合環境](https://www.ibm.com/developerworks/cn/java/j-lo-jenkins/)
