可配置
---

讓我們寫的 Web 應用可配置是一項很有挑戰性，也很實用的技能。

起先，我們在本地開發的時候為本地建立了一套環境，也建立了本地的配置。接著我們需要將我們的包部署到測試環境，也生成了測試環境的相應配置。這其中如果有其他的環境，我們也需要建立相應的環境。最後，我們還需要為產品環境建立全新的配置。

下圖是 Druapl 框架的部署流:

![Drupal Deployment Flow](assets/article/chapter4/deployment-flow.png)

在不同的環境下，他們使用不同的 Content。這些 Content 的內容不僅僅可以是一些系統相當的配置，也可以是一些不同環境下的 UI 等等。而在這其中也會涉及到一些比較複雜的知識，下面只是做一些簡單的介紹。

###環境配置

最常見的例子就是我們需要在不同的環境有不同的配置。大原則就是我們不能直接使用產品的環境測試，因此我們就需要為不同的環境配置不同的資料庫：

 - 開發環境。即開發者用於開發的環境，大部分的資料都是由我們自己注入的，在開發的過程中我們也會新增一些資料。
 - 整合測試環境/測試環境。和開發環境一樣，這些資料也是由我們注入的，而這些資料主要用於測試目的。當應用出現Bug時，我們可能就需要新增新的測試及其測試資料。
 - 模擬環境（Staging)。在軟體最終釋出前，開發或者設計人員對軟體進行調整後可以及時預覽改變的測試環境，這個環境更接近於產品最終釋出後的執行環境。因此，這個環境的資料一般來說就是產品環境的一些舊資料——可能是幾個月前，幾年前的資料。
 - 產品環境。即線上環境，都是真實的使用者資料。

因此從理論上來說，我們就需要4~5個不同的資料庫配置。而這些不同的資料庫配置並不代表著他們使用的是相同的資料庫。我們可以在本地環境使用 SQLite，而在我們的產品環境使用 MySQL。不過，最好的情況是我們應該使用同一個配置。這樣當出現問題的時候，我們也很容易排查、

而除了資料庫配置之外，我們還有一些其他配置。因此針對於不同的環境的配置最好獨立地寫在不同的檔案裡。並且這些配置最好可以以檔名來區分，如針對於開發環境，就是 ``dev.config.js``，針對於測試環境就是 ``test.config.js``。

因此，為了實現不同的環境使用不同的配置，我們就需要有一個變更控制。如果我們只有相應的配置，而沒有對應的執行機制那就有問題了。

###執行機制

當我們的應用程式在伺服器上執行得好好的時候，我們可能就不想因為修改配置而去重啟機器，這時候我們就需要配置熱載入。即我們修改配置後，不需要重啟服務即可以使用新的配置。對應的還有一種，便是我們需要重啟機器才能實現配置。

無論是哪種方式都需要修改配置來實現。而在我們使用的過程中熱載入可能需要消耗一些系統資源，因為我們的系統需要不斷地讀取配置的狀態並對其進行判斷。並且如果我們的應用執行在多個機器上的時候，我們可能需要一個個的上支個性。而如果是冷啟動的話，就可以考慮使用自動部署的方式來完成。

對應的，我們也需要在我們的程式碼中實現判斷這些配置的邏輯。

###功能開關

當我們上線了新功能之後，這時候如果有個 Bug，那麼我們是下線麼？要知道這個版本里麵包含了很多的 Bug 修復。如果在設計這個新功能的時候，有一個可配置的 Toogle，那麼我們就不需要下線了。只需要切換這個toggle，就可以解決問題了。

對於有多套環境的開發來說，如果我們針對不同的環境都有不同的配置，那麼這個靈活的開發會幫助我們更好的開發。

####Feature Toggle

它是一種允許控制線上功能開啟或者關閉的方式，通常會採取配置檔案的方式來控制。其過程如下圖所示：

![Feature Toggle](assets/article/chapter4/feature-toggle.png)

當我們需要 A 功能的時候，我們就只需要把 A 功能的開關開啟。當我們需要 B 功能，而不需要 A 功能的時候，我們就可以把相應的功能關掉。像在 Java 裡的 Spring 框架，就可以用 PropertyPlaceHolder 來做相似的事。使用 bean 檔案建立一個 properties

```xml
<util:properties id="myProps" location="WEB-INF/config/prop.properties"/>
```

然後注入這個值：

```
@Value("#{myProps['message']}")
```

我們可以直接判斷這個值是否是真，從而顯示這個內容。

```
<spring:eval expression="@myProps.message" var="messageToggle"/>

<c:if test="${messageToggle eq true}">
    message
</c:if>
```

這是一種很實用，而且很有趣的技術。

參考書籍：**《配置管理最佳實踐》**
