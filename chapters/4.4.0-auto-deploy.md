自動化部署
---

優化開發流程有一個很重要的步驟就是：讓部署自動化。通過部署自動化，我們可以大大縮減開發週期，加快軟體交付流程。下圖是一個自動化部署的流程圖：

![自動化部署](assets/article/chapter4/auto-deployment.png)

從下圖中我們可以得到下面的五個步驟：

 - 獲取源碼
 - 獲取依賴
 - 構建軟體包
 - 生成/上傳安裝包
 - 目標平臺安裝/配置

這個過程可能和之前的 Web 項目構建過程差不多，然而卻多了好幾步。

在前面的章節裡，我們已經使用了版本管理系統來管理我們的源碼。因此，在這裡對於獲取源碼的介紹就比較簡單了——我們只需要在我們的 CI（持續整合）伺服器上使用 ``git clone`` 這一類的方法來獲取我們的源碼即可。

###依賴與包倉庫

獲取完源碼後，我們就需要開始下載軟體包依賴。無論是 Python、Ruby、Java，還是 JavaScript 都需要這樣的一個過程。軟體開發已經從大教堂式的開發走向了集市——開源軟體改變了這一切。

![大教堂與集市](assets/article/chapter4/hierarchy-vs-graph.png)

過去我們需要在大系統的內部構建所使用的依賴，現在我們更多地藉助於外部的庫來實現這些功能。這也意味著，如果在這一個節點裡出現了意外——軟體被刪除，那麼這個系統將陷入癱瘓的狀態。如之前在 NPM 圈發生了“一個 17 行的模組引發的血案”——即 left-pad 工具模組被作者從 NPM 上撤下，所有直接或者間接依賴這個模組的 NPM 的軟體包都掛掉了。因為我們依賴於公有的包服務，所以系統便嚴重依賴於外部條件。

這時候一種簡單、有效的方案就是搭建自己的包服務。如使用 Java 技術棧的項目，就會使用 Nexus 搭建自己的 Maven 私有服務。我們的軟體依賴包將會依賴於我們自己的服務，此時會產生的主要問題可能就是：我們的軟體包不是最新的。但是對於追求穩定的項目來說，這個並不是必須的需求，反而是個優勢。

###構建軟體包

在一些編譯型語言裡，在我們執行包測試後，將會得到一個軟體包。如 Jar 包，它是 Java 所特有的一種壓縮文件。Jar 包無法直接安裝使用，雖然我們可以直接執行這個 Jar 包，但是我們需要通過一些手段將這個 Jar 包拷貝到我們的伺服器上，然後執行。在特定的時候，我們還需要修改配置才能完成我們的工作。

因此，使用 RPM 或者 DEB 包會是一種更好的選擇。RPM 全稱是 Red Hat Package Manager（Red Hat包管理器），它工作於 Red Hat Linux 以及其它 Linux 和 UNIX 系統，可被任何人使用。如下圖是 RPM 包的構建過程：

![RPM Build Process](assets/article/chapter4/rpm-deploy.jpg)

要構建一個標準的 RPM 包，我們需要建立 .spec檔案，這個檔案包含軟體打包的全部資訊——如包的 Summary、Name、Version、Copyright、Vendor 等等。在產生完這一個配置檔案後，執行 rpmbuild 命令，系統會按照步驟生成目標 RPM 包。

###上傳和安裝軟體包

生成對應的軟體包後，我們就可以將其上傳到 Koji 上，它是 Fedora 社羣的編譯系統。如下圖所示：

![RPM Build Process](assets/article/chapter4/rpm-koji.jpg)

如果我們已經對我們的所有目標作業系統配置過，即配置好了軟體源，那麼我們就可以直接在我們的伺服器上使用包管理工具安裝，如``yum install``。
